
(() => {
  const $ = (s, r=document)=>r.querySelector(s);
  const chat = $("#chatLog");
  const input = $("#chatInput");
  const sendBtn = $("#sendBtn");
  const typing = $("#typing");
  const demoBadge = $("#demoBadge");

  const safety = {
    pii: /(social security|ssn|passport|driver'?s license|bank account|routing number|credit card|dob|date of birth)/i,
    urgent: /(tomorrow|today|court date|hearing|deadline|eviction notice|protective order|warrant)/i,
    askAdvice: /(what should i do|tell me what to do|can you represent|write my defense|guarantee|will i win)/i,
    illegal: /(forge|fake|hide evidence|destroy evidence|lie to the court)/i
  };

  const now = () => new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});

  function addBubble(role, html){
    const wrap = document.createElement("div");
    wrap.className = "bubble " + role;
    wrap.innerHTML = `
      <div class="meta">
        <span class="role">${role === "user" ? "You" : "CommonCounsel AI (demo)"}</span>
        <span class="time">${now()}</span>
      </div>
      <div class="content">${html}</div>
    `;
    chat.appendChild(wrap);
    chat.scrollTop = chat.scrollHeight;
  }

  function escapeHtml(str){
    return str.replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
  }

  function responseFor(text){
    const t = text.trim();

    const flags = [];
    if (safety.pii.test(t)) flags.push("Sensitive personal info");
    if (safety.urgent.test(t)) flags.push("Time-sensitive / urgent");
    if (safety.askAdvice.test(t)) flags.push("Request for legal advice or directives");
    if (safety.illegal.test(t)) flags.push("Request involving wrongdoing");

    const disclaimer = `<div class="note">
      <span class="pill">Not a lawyer</span>
      <span class="pill">Virginia-focused info</span>
      <span class="pill">No legal advice</span>
    </div>`;

    if (flags.length){
      const bullets = flags.map(f => `<li>${escapeHtml(f)}</li>`).join("");
      return `
        ${disclaimer}
        <h4>Safety check</h4>
        <p>I can help with <b>general legal information</b> and document understanding in a Virginia context, but I can’t give legal advice or tell you what to do.</p>
        <div class="callout warn">
          <b>Why I’m pausing:</b>
          <ul>${bullets}</ul>
        </div>
        <h4>What I can do instead</h4>
        <ul>
          <li>Explain terms and process in plain English (Virginia framing where relevant)</li>
          <li>List options people commonly consider (informational, not a recommendation)</li>
          <li>Suggest questions to ask a licensed Virginia attorney</li>
        </ul>
        <h4>Questions to clarify (optional)</h4>
        <ul>
          <li>What type of matter is this (lease, consumer debt, small claims, custody, etc.)?</li>
          <li>What county/city in Virginia, if you’re comfortable sharing at a high level?</li>
          <li>What documents do you have (notice letter, lease clause, court filing) — you can paste non-sensitive excerpts</li>
        </ul>
        <div class="callout">
          <b>If you have a deadline, safety issue, or court date soon:</b> consider contacting a licensed Virginia attorney or local legal aid as soon as possible.
        </div>
      `;
    }

    // Normal response
    return `
      ${disclaimer}
      <h4>Plain-English summary</h4>
      <p>Here’s a structured, Virginia-aware overview based on what you shared (informational only):</p>
      <div class="callout">
        <ul>
          <li><b>What this appears to involve:</b> ${escapeHtml(t.slice(0, 140) || "—")}${t.length>140?"…":""}</li>
          <li><b>Common terms to watch:</b> notice requirements, deadlines, fees, cure periods</li>
          <li><b>How Virginia context may matter:</b> venue (county/city), timeline rules, and document wording</li>
        </ul>
      </div>
      <h4>Possible next steps (informational, not directives)</h4>
      <ol>
        <li>Gather the relevant documents and isolate the exact clause/notice language.</li>
        <li>Check for any deadlines or required notices in writing.</li>
        <li>If the situation is high-stakes or time-sensitive, consult a licensed Virginia attorney.</li>
      </ol>
      <h4>Questions to ask a lawyer</h4>
      <ul>
        <li>Which Virginia statute, local rule, or contract clause controls this?</li>
        <li>What timeline applies, and what evidence should I preserve?</li>
        <li>What outcomes are typical in my jurisdiction?</li>
      </ul>
      <p class="small">Demo note: responses are generated by a placeholder rules engine to showcase UX and guardrails.</p>
    `;
  }

  async function send(){
    const text = input.value;
    if (!text.trim()) return;
    addBubble("user", `<p>${escapeHtml(text)}</p>`);
    input.value = "";
    input.focus();

    typing.hidden = false;
    sendBtn.disabled = true;

    await new Promise(r => setTimeout(r, 650));
    const html = responseFor(text);
    addBubble("assistant", html);

    typing.hidden = true;
    sendBtn.disabled = false;
  }

  if (sendBtn) sendBtn.addEventListener("click", send);
  if (input) input.addEventListener("keydown", (e) => {
    if (e.key === "Enter" && (e.metaKey || e.ctrlKey)){
      e.preventDefault();
      send();
    }
  });

  // Seed chat
  addBubble("assistant", `
    <div class="note">
      <span class="pill">This is a demo</span>
      <span class="pill">Do not share sensitive info</span>
    </div>
    <p>Hi — I’m <b>${brand_name}</b> (demo). Ask a Virginia-focused legal information question or paste a <b>non-sensitive</b> excerpt from a document.</p>
    <p class="small">Try: “Explain what a ‘cure period’ means in a lease” or “Summarize this contract clause…”</p>
  `);
})();
